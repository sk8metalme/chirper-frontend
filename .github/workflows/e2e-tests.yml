name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'  # 毎日0時に実行
  workflow_dispatch:

env:
  CI: true
  JAVA_VERSION: '21'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            google-chrome-stable \
            fonts-liberation \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libwayland-client0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            xdg-utils

      - name: Verify Chrome installation
        run: |
          google-chrome --version
          which google-chrome

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run E2E tests
        run: ./gradlew e2eTest --info
        env:
          CI: true

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports
          path: |
            build/reports/tests/e2eTest/
            build/test-results/e2eTest/
          retention-days: 7

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: build/reports/tests/e2e/
          retention-days: 7

      - name: Test Report Summary
        if: always()
        run: |
          if [ -f build/test-results/e2eTest/TEST-*.xml ]; then
            echo "### E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Test reports have been generated." >> $GITHUB_STEP_SUMMARY
            echo "Check the artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
          else
            echo "### E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

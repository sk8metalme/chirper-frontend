# chirper-frontend - 要件定義書

## プロジェクト情報

- **プロジェクト名**: chirper-frontend
- **親プロジェクト**: chirper（Twitter風SNSアプリケーション）
- **JIRAキー**: PC
- **Confluenceスペース**: MICHI
- **作成日時**: 2025-12-23T05:54:00.000Z

## 概要

chirper-frontendは、Twitter風SNSアプリケーション「Chirper」のWebユーザーインターフェースを提供するサービスです。Spring Boot + Thymeleafを使用したサーバーサイドレンダリングで、Bootstrap 5によるレスポンシブデザインを実現します。オニオンアーキテクチャを採用し、ビジネスロジックをインフラストラクチャから分離することで、保守性とテスト容易性を向上させます。

## ビジネス価値

### 対象ユーザー

- **一般ユーザー**: ソーシャルネットワーキングサービスを利用したい個人
- **コンテンツクリエイター**: 情報発信・コミュニティ形成を行いたい個人・団体
- **企業・組織**: ブランディング・マーケティング活動を行いたい法人

### Frontend Serviceの責務

1. **ユーザーインターフェース提供**: 直感的で使いやすいUI/UX
2. **Backend API連携**: REST APIを通じたデータ取得・送信
3. **クライアント側バリデーション**: ユーザー入力の即座の検証
4. **セッション管理**: JWTトークンの管理、認証状態の維持
5. **レスポンシブデザイン**: デスクトップ・タブレット・スマートフォン対応

### ビジネス目標

- 直感的で使いやすいユーザーインターフェースの提供
- 快適なページ遷移とスムーズなユーザー体験
- アクセシビリティに配慮したデザイン

## サービス構成

### Frontend Service のアーキテクチャ

Frontend ServiceはBackend Serviceと同様に**オニオンアーキテクチャ（Onion Architecture）**を採用します。これにより、チーム全体で統一されたアーキテクチャパターンを共有し、保守性とテスタビリティを向上させます。

#### レイヤー構成

1. **Domain Layer（ドメイン層）** - 中核
   - プレゼンテーションドメインのビジネスロジックとルール
   - ViewModel Entities、Value Objects、Domain Services
   - 外部依存なし、純粋なJavaクラス

2. **Application Layer（アプリケーション層）**
   - 画面表示・操作のユースケース実装
   - Backend APIとのデータ転送（DTO）
   - Domain Layerに依存

3. **Infrastructure Layer（インフラストラクチャ層）**
   - Backend APIとの統合（WebClient/RestTemplate）
   - セッション管理、JWTトークン管理
   - Domain Layerのインターフェースを実装

4. **Presentation Layer（プレゼンテーション層）** - 最外層
   - Spring MVCコントローラ（薄く保つ）
   - Thymeleafテンプレート（Views）
   - グローバル例外ハンドリング

### Backend API依存関係

Frontend ServiceはBackend Serviceが提供するREST APIに依存します：

| API種別 | エンドポイント | 用途 | 認証 |
|--------|---------------|------|------|
| 認証API | `POST /api/v1/auth/login` | ユーザーログイン | 不要 |
| 認証API | `POST /api/v1/auth/register` | ユーザー登録 | 不要 |
| ツイートAPI | `POST /api/v1/tweets` | ツイート投稿 | 必須 |
| ツイートAPI | `GET /api/v1/tweets/{tweetId}` | ツイート取得 | 任意 |
| ツイートAPI | `DELETE /api/v1/tweets/{tweetId}` | ツイート削除 | 必須 |
| タイムラインAPI | `GET /api/v1/timeline` | タイムライン取得 | 必須 |
| ソーシャルAPI | `POST /api/v1/users/{userId}/follow` | フォロー | 必須 |
| ソーシャルAPI | `POST /api/v1/tweets/{tweetId}/like` | いいね | 必須 |
| ソーシャルAPI | `POST /api/v1/tweets/{tweetId}/retweet` | リツイート | 必須 |

## インターフェース要件

### 画面一覧

#### 1. ホーム画面（`/`）
- **用途**: 未ログインユーザー向けランディングページ
- **表示内容**: サービス紹介、ログイン/登録ボタン
- **アクション**: ログイン画面へ遷移、登録画面へ遷移

#### 2. ログイン画面（`/login`）
- **用途**: ユーザー認証
- **入力項目**: ユーザー名、パスワード
- **バリデーション**:
  - ユーザー名: 必須、3-20文字
  - パスワード: 必須、8文字以上
- **アクション**: ログイン実行（Backend API呼び出し）、登録画面へ遷移
- **成功時**: タイムライン画面へリダイレクト、JWTトークンをセッションストレージに保存
- **失敗時**: エラーメッセージ表示

#### 3. 登録画面（`/register`）
- **用途**: 新規ユーザー登録
- **入力項目**: ユーザー名、メールアドレス、パスワード、パスワード確認
- **バリデーション**:
  - ユーザー名: 必須、3-20文字、半角英数字・アンダースコアのみ
  - メールアドレス: 必須、メール形式
  - パスワード: 必須、8文字以上、英数字記号を含む
  - パスワード確認: パスワードと一致
- **アクション**: 登録実行（Backend API呼び出し）
- **成功時**: ログイン画面へリダイレクト、成功メッセージ表示
- **失敗時**: エラーメッセージ表示

#### 4. タイムライン画面（`/timeline`）
- **用途**: フォローユーザーのツイート表示
- **表示内容**:
  - ツイート投稿フォーム（最上部）
  - フォローユーザーのツイート一覧（新しい順）
  - 各ツイート: ユーザー名、アバター、投稿内容、投稿日時、いいね数、リツイート数
  - ページネーション（20件/ページ）
- **アクション**:
  - ツイート投稿（モーダルまたはインライン）
  - いいねボタンクリック
  - リツイートボタンクリック
  - ユーザー名クリック（プロフィール画面へ遷移）
  - ツイートクリック（ツイート詳細画面へ遷移）
- **認証**: 必須（未ログイン時はログイン画面へリダイレクト）

#### 5. プロフィール画面（`/profile/{username}`）
- **用途**: ユーザープロフィール表示
- **表示内容**:
  - ユーザー情報（ユーザー名、表示名、自己紹介、アバター）
  - フォロー数、フォロワー数
  - ユーザーのツイート一覧
- **アクション**:
  - フォローボタンクリック（自分以外）
  - プロフィール編集ボタンクリック（自分のみ）
- **認証**: 任意（未ログイン時は閲覧のみ）

#### 6. プロフィール編集画面（`/profile/edit`）
- **用途**: プロフィール情報の編集
- **入力項目**: 表示名、自己紹介、アバター画像URL
- **バリデーション**:
  - 表示名: 任意、最大50文字
  - 自己紹介: 任意、最大160文字
  - アバター画像URL: 任意、URL形式
- **アクション**: 更新実行（Backend API呼び出し）
- **成功時**: プロフィール画面へリダイレクト、成功メッセージ表示
- **認証**: 必須

### UIコンポーネント

#### 1. ナビゲーションバー（`components/navbar.html`）
- **表示位置**: 全画面共通（最上部）
- **表示内容**（ログイン時）:
  - Chirperロゴ（ホームリンク）
  - タイムラインリンク
  - プロフィールリンク
  - ログアウトボタン
- **表示内容**（未ログイン時）:
  - Chirperロゴ（ホームリンク）
  - ログインボタン
  - 登録ボタン

#### 2. ツイートカード（`components/tweet.html`）
- **表示内容**:
  - ユーザーアバター
  - ユーザー名、@username
  - 投稿内容（@mention、#hashtag、URLをハイライト）
  - 相対時刻表示（"3分前"、"2時間前"、"12月23日"）
  - いいねボタン + いいね数
  - リツイートボタン + リツイート数
- **アクション**:
  - ユーザー名クリック（プロフィール画面へ遷移）
  - いいねボタンクリック（未いいね→いいね、いいね済み→取り消し）
  - リツイートボタンクリック

#### 3. ツイート投稿フォーム（`components/tweet-form.html`）
- **表示位置**: タイムライン画面最上部
- **入力項目**: ツイート本文（テキストエリア）
- **バリデーション**:
  - 1-280文字（リアルタイム文字数カウント表示）
- **アクション**: ツイート投稿ボタンクリック
- **成功時**: フォームクリア、タイムライン再読み込み、成功メッセージ表示

### データフォーマット

- **文字エンコーディング**: UTF-8
- **日時形式**: ISO 8601（Backend APIから取得）→ 相対時刻に変換（"3分前"）
- **認証**: JWTトークンをセッションストレージに保存（`sessionStorage.setItem('jwt_token', token)`）
- **API通信**: JSON（Content-Type: application/json）

### エラーハンドリング

#### クライアント側エラー

**バリデーションエラー**:
- フォーム送信前にクライアント側でバリデーション
- エラーメッセージを該当フィールドの下に赤字で表示
- 送信ボタンを無効化

**ネットワークエラー**:
- API呼び出し失敗時、トースト通知でエラーメッセージ表示
- リトライボタンを表示

**認証エラー（401 Unauthorized）**:
- セッションストレージからJWTトークンを削除
- ログイン画面へリダイレクト
- メッセージ: "セッションが期限切れです。再度ログインしてください。"

#### サーバー側エラー

Backend APIから返却されるエラーレスポンスを処理：

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "ユーザー名は3文字以上である必要があります",
    "details": [
      {
        "field": "username",
        "message": "3文字以上入力してください"
      }
    ],
    "timestamp": "2025-12-23T05:54:00.000Z"
  }
}
```

**エラーコード別処理**:
- `VALIDATION_ERROR` (400): フィールドエラーを該当箇所に表示
- `UNAUTHORIZED` (401): ログイン画面へリダイレクト
- `FORBIDDEN` (403): "権限がありません" メッセージ表示
- `NOT_FOUND` (404): "ページが見つかりません" エラーページ表示
- `CONFLICT` (409): "既に存在します" メッセージ表示
- `INTERNAL_ERROR` (500): "サーバーエラーが発生しました" メッセージ表示

## 機能要件（EARS形式）

### 必須要件

#### 認証・ログイン機能

- **WHEN** ユーザーがログインフォームを送信する際、**IF** ユーザー名が3-20文字かつパスワードが8文字以上である場合、**THEN** Frontend ServiceはBackend API（`POST /api/v1/auth/login`）を呼び出し、JWTトークンをセッションストレージに保存し、タイムライン画面へリダイレクトする。

- **WHEN** Backend APIが401エラーを返却する際、**IF** ログインフォーム送信時である場合、**THEN** Frontend Serviceはログイン画面に "ユーザー名またはパスワードが正しくありません" というエラーメッセージを表示する。

- **WHEN** ユーザーがログアウトボタンをクリックする際、**THEN** Frontend ServiceはセッションストレージからJWTトークンを削除し、ログイン画面へリダイレクトする。

#### ユーザー登録機能

- **WHEN** ユーザーが登録フォームを送信する際、**IF** すべての入力項目が有効である場合、**THEN** Frontend ServiceはBackend API（`POST /api/v1/auth/register`）を呼び出し、成功時にログイン画面へリダイレクトし、"登録が完了しました。ログインしてください。" というメッセージを表示する。

- **WHEN** ユーザーが登録フォームにパスワードを入力する際、**IF** パスワードとパスワード確認が一致しない場合、**THEN** Frontend Serviceは "パスワードが一致しません" というエラーメッセージを表示し、送信ボタンを無効化する。

#### タイムライン表示機能

- **WHEN** 認証済みユーザーがタイムライン画面を開く際、**THEN** Frontend ServiceはBackend API（`GET /api/v1/timeline?page=0&size=20`）を呼び出し、フォローユーザーのツイートを新しい順に表示する。

- **WHEN** ユーザーがタイムラインをスクロールして最下部に到達する際、**IF** 次のページが存在する場合、**THEN** Frontend ServiceはBackend API（`GET /api/v1/timeline?page={nextPage}&size=20`）を呼び出し、追加のツイートを読み込み表示する（無限スクロール）。

- **WHEN** タイムラインにツイートが表示される際、**THEN** Frontend Serviceは投稿日時を相対時刻（"3分前"、"2時間前"、"12月23日"）に変換して表示する。

#### ツイート投稿機能

- **WHEN** 認証済みユーザーがツイート投稿フォームにテキストを入力する際、**IF** 文字数が1-280文字である場合、**THEN** Frontend Serviceは投稿ボタンを有効化し、リアルタイムで残り文字数を表示する。

- **WHEN** ユーザーがツイート投稿ボタンをクリックする際、**IF** 文字数が1-280文字である場合、**THEN** Frontend ServiceはBackend API（`POST /api/v1/tweets`）を呼び出し、成功時にフォームをクリアし、タイムラインを再読み込みし、"ツイートを投稿しました" というメッセージを表示する。

#### プロフィール表示機能

- **WHEN** ユーザーがプロフィール画面にアクセスする際、**THEN** Frontend ServiceはBackend API（`GET /api/v1/users/{username}`）を呼び出し、ユーザー情報（ユーザー名、表示名、自己紹介、アバター、フォロー数、フォロワー数）とユーザーのツイート一覧を表示する。

- **WHEN** 認証済みユーザーが他ユーザーのプロフィール画面を表示する際、**IF** 未フォロー状態である場合、**THEN** Frontend Serviceは "フォローする" ボタンを表示し、フォロー済み状態である場合は "フォロー中" ボタンを表示する。

#### ソーシャル機能

- **WHEN** ユーザーがツイートのいいねボタンをクリックする際、**IF** 未いいね状態である場合、**THEN** Frontend ServiceはBackend API（`POST /api/v1/tweets/{tweetId}/like`）を呼び出し、成功時にボタンの色を赤色に変更し、いいね数をインクリメントする。

- **WHEN** ユーザーがツイートのいいねボタンをクリックする際、**IF** いいね済み状態である場合、**THEN** Frontend ServiceはBackend API（`DELETE /api/v1/tweets/{tweetId}/like`）を呼び出し、成功時にボタンの色を元に戻し、いいね数をデクリメントする。

- **WHEN** ユーザーがリツイートボタンをクリックする際、**IF** 未リツイート状態である場合、**THEN** Frontend ServiceはBackend API（`POST /api/v1/tweets/{tweetId}/retweet`）を呼び出し、成功時にボタンの色を緑色に変更し、リツイート数をインクリメントし、タイムラインを再読み込みする。

#### コンテンツレンダリング機能

- **WHEN** ツイート本文が表示される際、**IF** 本文に@usernameが含まれる場合、**THEN** Frontend Serviceは@usernameを青色のリンクとしてハイライトし、クリック時に該当ユーザーのプロフィール画面へ遷移する。

- **WHEN** ツイート本文が表示される際、**IF** 本文に#hashtagが含まれる場合、**THEN** Frontend Serviceは#hashtagを青色のテキストとしてハイライトする（リンク機能は任意要件）。

- **WHEN** ツイート本文が表示される際、**IF** 本文にURLが含まれる場合、**THEN** Frontend ServiceはURLを青色のリンクとしてハイライトし、クリック時に新しいタブで該当ページを開く。

### 任意要件

- **WHEN** ユーザーがツイートに画像を添付する際、**IF** 画像形式がJPEG/PNG/GIFであり、サイズが5MB以下である場合、**THEN** Frontend Serviceは画像をプレビュー表示し、Backend APIにアップロードし、ツイートに添付する。

- **WHEN** ユーザーがハッシュタグ検索を実行する際、**IF** 検索キーワードが2文字以上である場合、**THEN** Frontend ServiceはBackend API（`GET /api/v1/search?q={keyword}`）を呼び出し、関連するツイートを表示する。

- **WHEN** ユーザーがダークモードトグルをクリックする際、**THEN** Frontend ServiceはBootstrapのダークモードテーマを適用し、設定をローカルストレージに保存する。

## 技術的制約

### アーキテクチャ制約

- **オニオンアーキテクチャ**: Frontend Serviceはオニオンアーキテクチャを採用し、Domain層、Application層、Infrastructure層、Presentation層の4層で構成する
- **依存関係の方向**: 外側の層は内側の層に依存するが、内側の層は外側の層に依存しない
- **ドメイン駆動設計**: Domain層にプレゼンテーションドメインのビジネスロジックを集約する

### 技術スタック制約

- **Java**: Java 21 LTS
- **Spring Boot**: Spring Boot 3.4.x
- **Thymeleaf**: Thymeleaf 3.1.x（サーバーサイドレンダリング）
- **Bootstrap**: Bootstrap 5.x（CSSフレームワーク）
- **APIクライアント**: WebClient（推奨）または RestTemplate

### セキュリティ制約

- **XSS対策**: Thymeleafの自動エスケープを有効化（`th:text`、`th:utext`を適切に使い分け）
- **CSRF対策**: Spring Securityのデフォルト設定を使用（フォームに`th:csrf`トークンを含める）
- **セッション管理**: セキュアなセッションクッキー（HttpOnly、Secure、SameSite属性）
- **JWTトークン保存**: セッションストレージに保存（XSS対策としてローカルストレージは使用しない）

### ブラウザ対応

- **対応ブラウザ**: Chrome、Firefox、Safari、Edge（最新版）
- **非対応ブラウザ**: Internet Explorer
- **JavaScript**: ES6+を使用可能

## 非機能要件

### パフォーマンス要件

- **初期表示**: タイムライン画面の初回表示が1秒以内に完了すること
- **ページ遷移**: 画面遷移が500ms以内に完了すること
- **API呼び出しタイムアウト**: Backend API呼び出しのタイムアウトを5秒に設定すること
- **画像最適化**: 画像を遅延ロード（lazy loading）し、初期表示を高速化すること

### セキュリティ要件

#### 認証・認可

- **JWT管理**: JWTトークンをセッションストレージに保存し、各API呼び出し時にAuthorizationヘッダーに含める
- **自動ログアウト**: JWTトークンの有効期限切れ時、自動的にログイン画面へリダイレクト
- **CSRF対策**: Spring SecurityのCSRF保護を有効化

#### データ保護

- **セッション管理**: セキュアなセッションクッキー（HttpOnly、Secure、SameSite属性）
- **通信の暗号化**: HTTPS（TLS 1.2以上）を使用（本番環境）

#### セキュリティヘッダー

Spring Securityで以下のセキュリティヘッダーを設定：
- **Content-Security-Policy**: XSS攻撃対策
- **X-Frame-Options**: クリックジャッキング対策
- **X-Content-Type-Options**: MIMEタイプスニッフィング対策
- **Strict-Transport-Security**: HTTPS強制

### ユーザビリティ要件

- **レスポンシブデザイン**: デスクトップ（1024px以上）、タブレット（768-1023px）、スマートフォン（〜767px）で最適表示
- **アクセシビリティ**: WCAG 2.1 レベルAA準拠（目標）
  - キーボード操作対応
  - スクリーンリーダー対応（ARIA属性）
  - 適切なカラーコントラスト比（4.5:1以上）
- **エラーメッセージ**: ユーザーフレンドリーなエラーメッセージを表示
- **ローディング表示**: API呼び出し中はスピナーを表示

### 保守性要件

#### モニタリング

- **アプリケーションログ**: INFO、WARN、ERRORレベルでログ出力
- **エラーログ**: API呼び出しエラー、レンダリングエラーを記録
- **ヘルスチェック**: `/actuator/health` エンドポイントで死活監視

#### ログ管理

- **ログフォーマット**: JSON形式（構造化ログ）
- **個人情報のマスキング**: パスワード、トークンはログに出力しない
- **ログローテーション**: 日次、7日間保持

#### テスト

- **単体テストカバレッジ**: 95%以上（Domain層、Application層）
- **E2Eテスト**: クリティカルなユーザーフロー（ログイン、ツイート投稿、タイムライン表示）をカバー
- **テストフレームワーク**: JUnit 5、Selenide（E2E）

## リスクと制限事項

### リスク

1. **Backend API依存リスク**: Backend Serviceが停止すると全機能が利用不可
   - **対策**: エラーハンドリング強化、フォールバック画面表示

2. **パフォーマンスリスク**: 大量のツイート表示によるブラウザのメモリ消費増加
   - **対策**: 仮想スクロール（Virtual Scrolling）の導入（任意要件）

3. **セキュリティリスク**: XSS攻撃、CSRF攻撃
   - **対策**: Thymeleaf自動エスケープ、Spring Security CSRF保護

### 制限事項

- **ブラウザサポート**: Internet Explorerは非対応
- **画像アップロード**: 任意要件（初期実装では画像URLのみ）
- **リアルタイム更新**: WebSocketによるリアルタイム更新は任意要件
- **オフライン機能**: ServiceWorkerによるオフライン対応は任意要件

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-12-23T05:54:00.000Z | 1.0.0 | 初版作成（Frontend側の要件定義） | Claude Code |
